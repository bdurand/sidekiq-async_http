#!/usr/bin/env bash
set -euo pipefail

# Run a valkey (redis-compatible) container using either the `container` tool
# (podman/docker replacement) or `docker` if available.
#
# Behavior:
# - Prefer `container` if present, otherwise `docker`.
# - Forward `VALKEY_PORT` if set (default 24455) to container port 6379.
# - Pass VALKEY_EXTRA_FLAGS as an environment variable to the container.
# - Print the exact command before running for transparency.

: "${VALKEY_PORT:=24455}"
: "${VALKEY_IMAGE:=docker.io/valkey/valkey:9.0.1-alpine}"
: "${VALKEY_EXTRA_FLAGS:=--loglevel warning --maxmemory 30m --maxmemory-policy allkeys-lru --databases 2}"

run_cmd=""
if command -v container >/dev/null 2>&1; then
  run_cmd="container run --rm -it -p ${VALKEY_PORT}:6379 --env VALKEY_EXTRA_FLAGS='${VALKEY_EXTRA_FLAGS}' ${VALKEY_IMAGE}"
elif command -v docker >/dev/null 2>&1; then
  run_cmd="docker run --rm -it -p ${VALKEY_PORT}:6379 -e VALKEY_EXTRA_FLAGS='${VALKEY_EXTRA_FLAGS}' ${VALKEY_IMAGE}"
else
  echo "Error: neither 'container' nor 'docker' command found in PATH." >&2
  exit 2
fi

echo "Running: ${run_cmd}"

# Use 'exec' so signals are forwarded to the container process.
exec sh -c "${run_cmd}"
