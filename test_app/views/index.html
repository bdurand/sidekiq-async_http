<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sidekiq AsyncHttp Test App</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="toast" class="toast"></div>

  <div class="container">
    <h1>ðŸš€ Sidekiq AsyncHttp Test Application</h1>

    <form id="job-form">
      <div class="form-group">
        <label for="async-count">Asynchronous Requests</label>
        <input
          type="number"
          id="async-count"
          name="async_count"
          value="50"
          min="0"
          max="5000"
          step="1"
          autocomplete="off"
          required
        >
        <div class="help-text">Number of asynchronous HTTP jobs to enqueue (0-5000)</div>
      </div>

      <div class="form-group">
        <label for="sync-count">Synchronous Requests</label>
        <input
          type="number"
          id="sync-count"
          name="sync_count"
          value="50"
          min="0"
          max="5000"
          step="1"
          autocomplete="off"
          required
        >
        <div class="help-text">Number of synchronous HTTP jobs to enqueue (0-5000)</div>
      </div>

      <div class="form-group">
        <label for="delay">Delay (seconds) & Drift (%)</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input
            type="number"
            id="delay"
            name="delay"
            value="5"
            min="0.0"
            max="60.0"
            step="any"
            autocomplete="off"
            placeholder="Seconds"
          >
          <div style="display: flex; align-items: center; gap: 5px; width: 60%;">
            <input
              type="number"
              id="delay_drift"
              name="delay_drift"
              value="50"
              min="0"
              max="100"
              step="1"
              autocomplete="off"
              placeholder="Drift"
            >
            <span style="font-size: 14px; font-weight: 600; color: #555;">%</span>
          </div>
        </div>
        <div class="help-text">HTTP endpoint delay in seconds and random drift percentage (0-100)</div>
      </div>

      <div class="form-group">
        <label for="timeout">Timeout (seconds)</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input
            type="number"
            id="timeout"
            name="timeout"
            value="30"
            min="0.1"
            max="60.0"
            step="any"
            autocomplete="off"
            style="width: 100%;"
          >
          <div class="checkbox-group" style="margin-top: 0; white-space: nowrap;">
            <input
              type="checkbox"
              id="use-activejob"
              name="use_activejob"
              value="1"
            >
            <label for="use-activejob">Use ActiveJob</label>
          </div>
        </div>
        <div class="help-text">Request timeout in seconds</div>
      </div>

      <button type="submit">Run Jobs</button>
    </form>

    <div class="status-section">
      <div class="status-title">Asynchronous HTTP Requests</div>
      <div class="status-grid three-col">
        <div class="status-card">
          <div class="status-label">In Flight</div>
          <div class="status-value" id="inflight-count">0</div>
        </div>
        <div class="status-card success">
          <div class="status-label">Completed</div>
          <div class="status-value" id="async-completed-count">0</div>
        </div>
        <div class="status-card failure">
          <div class="status-label">Error</div>
          <div class="status-value" id="async-error-count">0</div>
        </div>
      </div>
    </div>

    <div class="status-section">
      <div class="status-title">Synchronous HTTP Requests</div>
      <div class="status-grid">
        <div class="status-card success">
          <div class="status-label">Completed</div>
          <div class="status-value" id="sync-completed-count">0</div>
        </div>
        <div class="status-card failure">
          <div class="status-label">Error</div>
          <div class="status-value" id="sync-error-count">0</div>
        </div>
      </div>
    </div>

    <div class="status-section">
      <div class="status-title">Sidekiq Queue Stats</div>
      <div class="status-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
        <div class="status-card">
          <div class="status-label">Busy</div>
          <div class="status-value" id="busy-count">0</div>
        </div>
        <div class="status-card">
          <div class="status-label">Enqueued</div>
          <div class="status-value" id="enqueued-count">0</div>
        </div>
        <div class="status-card">
          <div class="status-label">Retry</div>
          <div class="status-value" id="retry-count">0</div>
        </div>
        <div class="status-card">
          <div class="status-label">Processed</div>
          <div class="status-value" id="processed-count">0</div>
        </div>
        <div class="status-card">
          <div class="status-label">Failed</div>
          <div class="status-value" id="failed-count">0</div>
        </div>
      </div>
      <div class="polling-indicator active" id="polling-status">Polling active</div>
    </div>

    <div class="links">
      <a href="/faraday">Faraday Adapter Test</a>
      <a href="/sidekiq" target="_blank">Sidekiq Dashboard</a>
    </div>
  </div>

  <script>
    (function() {
      // Toast notification
      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');

        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // Form submission
      const form = document.getElementById('job-form');
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const button = form.querySelector('button[type="submit"]');

        button.disabled = true;
        button.textContent = 'Submitting...';

        fetch('/run_jobs', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            const asyncCount = formData.get('async_count');
            const syncCount = formData.get('sync_count');
            const delay = formData.get('delay');
            const timeout = formData.get('timeout');
            const delayDrift = formData.get('delay_drift');
            const driftText = parseFloat(delayDrift) > 0 ? ` (Â±${delayDrift}%)` : '';
            const totalCount = parseInt(asyncCount) + parseInt(syncCount);
            showToast(`Successfully enqueued ${totalCount} jobs (${asyncCount} async, ${syncCount} sync) - ${delay}s delay${driftText}, ${timeout}s timeout!`);
            // Reset zero activity count and restart polling if stopped
            zeroActivityCount = 0;
            if (!isPolling) {
              startPolling();
              const statusEl = document.getElementById('polling-status');
              statusEl.textContent = 'Polling active';
              statusEl.className = 'polling-indicator active';
            }
          } else {
            showToast('Failed to enqueue jobs');
          }
        })
        .catch(err => {
          console.error('Error submitting form:', err);
          showToast('Error submitting form');
        })
        .finally(() => {
          button.disabled = false;
          button.textContent = 'Run Jobs';
        });
      });

      // Status polling
      let zeroActivityCount = 0;
      let pollInterval = null;
      let isPolling = false;

      function updateStatus(data) {
        const inflightEl = document.getElementById('inflight-count');
        const asyncCompletedEl = document.getElementById('async-completed-count');
        const asyncErrorEl = document.getElementById('async-error-count');
        const syncCompletedEl = document.getElementById('sync-completed-count');
        const syncErrorEl = document.getElementById('sync-error-count');
        const busyEl = document.getElementById('busy-count');
        const enqueuedEl = document.getElementById('enqueued-count');
        const processedEl = document.getElementById('processed-count');
        const retryEl = document.getElementById('retry-count');
        const failedEl = document.getElementById('failed-count');
        const statusEl = document.getElementById('polling-status');

        const inflight = data.inflight || 0;
        const busy = data.busy || 0;
        const enqueued = data.enqueued || 0;
        const retry = data.retry || 0;

        inflightEl.textContent = inflight;
        asyncCompletedEl.textContent = (data.asynchronous && data.asynchronous.complete) || 0;
        asyncErrorEl.textContent = (data.asynchronous && data.asynchronous.error) || 0;
        syncCompletedEl.textContent = (data.synchronous && data.synchronous.complete) || 0;
        syncErrorEl.textContent = (data.synchronous && data.synchronous.error) || 0;
        busyEl.textContent = busy;
        enqueuedEl.textContent = enqueued;
        processedEl.textContent = data.processed || 0;
        retryEl.textContent = retry;
        failedEl.textContent = data.failed || 0;

        // Track consecutive zero activity (inflight, busy, enqueued, and retry all zero)
        if (inflight === 0 && busy === 0 && enqueued === 0 && retry === 0) {
          zeroActivityCount++;
        } else {
          zeroActivityCount = 0;
        }

        // Stop polling if no activity 5 times in a row
        if (zeroActivityCount >= 5 && isPolling) {
          stopPolling();
          statusEl.textContent = 'Polling stopped (no activity)';
          statusEl.className = 'polling-indicator stopped';
        }
      }

      function fetchStatus() {
        fetch('/status')
          .then(response => response.json())
          .then(data => updateStatus(data))
          .catch(err => console.error('Failed to fetch status:', err));
      }

      function startPolling() {
        if (isPolling) return;

        isPolling = true;
        fetchStatus(); // Initial fetch
        pollInterval = setInterval(fetchStatus, 500);
      }

      function stopPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
        isPolling = false;
      }

      // Start polling on page load
      startPolling();

      // Stop polling when page is hidden/unloaded
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopPolling();
        } else {
          startPolling();
        }
      });
    })();
  </script>
</body>
</html>
